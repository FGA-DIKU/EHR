name: 'Pipeline test'

on:
  workflow_dispatch:
  pull_request:

permissions:
  contents: read
  pull-requests: read
  actions: write

jobs:
  initial_steps:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup + dependencies
        uses: ./.github/actions/setup

      - name: main.create_data
        run: |
          source .venv/bin/activate
          python -m corebehrt.main.create_data
      
      - name: main.prepare_training_data
        run: |
          source .venv/bin/activate
          python -m corebehrt.main.prepare_training_data --config_path ./corebehrt/configs/prepare_pretrain.yaml
      
      - name: main.create_outcomes
        run: |
          source .venv/bin/activate
          python -m corebehrt.main.create_outcomes
      
      - name: Upload outputs
        uses: actions/upload-artifact@v4
        with:
          name: initial_outputs
          path: "./outputs"

  pretrain_jobs:
    needs: initial_steps
    runs-on: ubuntu-latest
    strategy:
      matrix:
        pretrain_type: [standard, causal]
      fail-fast: false
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup + dependencies
        uses: ./.github/actions/setup

      - name: Download outputs
        uses: actions/download-artifact@v4
        with:
          name: initial_outputs
          path: "./outputs"
      
      - name: Run standard pretrain
        if: matrix.pretrain_type == 'standard'
        run: |
          source .venv/bin/activate
          python -m corebehrt.main.pretrain
      
      - name: Run causal pretrain
        if: matrix.pretrain_type == 'causal'
        run: |
          source .venv/bin/activate
          python -m corebehrt.main.pretrain --config_path ./corebehrt/configs/pretrain_causal.yaml
      
      - name: Upload pretrain outputs
        uses: actions/upload-artifact@v4
        with:
          name: pretrain_${{ matrix.pretrain_type }}_outputs
          path: "./outputs"

  finetune_and_evaluation:
    needs: [initial_steps, pretrain_jobs]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup + dependencies
        uses: ./.github/actions/setup

      - name: Download initial outputs
        uses: actions/download-artifact@v4
        with:
          name: initial_outputs
          path: "./outputs"
          
      - name: Download standard pretrain outputs
        uses: actions/download-artifact@v4
        with:
          name: pretrain_standard_outputs
          path: "./outputs"
      
      - name: main.select_cohort
        run: |
          source .venv/bin/activate
          python -m corebehrt.main.select_cohort
      
      - name: main.prepare_training_data for finetune
        run: |
          source .venv/bin/activate
          python -m corebehrt.main.prepare_training_data --config_path ./corebehrt/configs/prepare_finetune.yaml
      
      - name: main.finetune_cv
        run: |
          source .venv/bin/activate
          python -m corebehrt.main.finetune_cv
      
      - name: main.select_cohort_absolute
        run: |
          source .venv/bin/activate
          python -m corebehrt.main.select_cohort --config_path ./corebehrt/configs/select_cohort_absolute.yaml
      
      - name: main.finetune_oot
        run: |
          source .venv/bin/activate
          python -m corebehrt.main.finetune_cv --config_path ./corebehrt/configs/finetune_oot.yaml
      
      - name: main.select_cohort_held_out
        run: |
          source .venv/bin/activate
          python -m corebehrt.main.select_cohort --config_path ./corebehrt/configs/select_cohort_held_out.yaml
      
      - name: main.prepare_training_data for held out
        run: |
          source .venv/bin/activate
          python -m corebehrt.main.prepare_training_data --config_path ./corebehrt/configs/prepare_held_out.yaml
      
      - name: main.evaluate_finetune
        run: |
          source .venv/bin/activate
          python -m corebehrt.main.evaluate_finetune
      
      - name: Upload final outputs
        uses: actions/upload-artifact@v4
        with:
          name: final_outputs
          path: "./outputs"